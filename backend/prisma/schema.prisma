generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  email      String   @unique
  password   String
  firstName  String
  lastName   String
  role       Role
  studentId  String?  @unique
  employeeId String?  @unique
  section    String?
  year       Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  attendanceRecords Attendance[]
  assignments       Assignment[] @relation("AssignmentCreator")
  submissions       Submission[]
  notices           Notice[]
  sentMessages      Message[]    @relation("MessageSender")
  receivedMessages  Message[]    @relation("MessageReceiver")
  enrollments       Enrollment[]
  predictions       Prediction[]
  facultyCourses    FacultyCourse[]
  studentLeaves     LeaveApplication[] @relation("StudentLeaves")
  facultyApprovedLeaves LeaveApplication[] @relation("FacultyApprovedLeaves")
  adminApprovedLeaves   LeaveApplication[] @relation("AdminApprovedLeaves")

  @@map("users")
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  code        String   @unique
  description String?
  credits     Int
  semesterId  String?  @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  semester        Semester?      @relation(fields: [semesterId], references: [id])
  enrollments     Enrollment[]
  assignments     Assignment[]
  attendance      Attendance[]
  timetable       Timetable[]
  facultyCourses  FacultyCourse[]

  @@map("courses")
}

model Semester {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String   @unique
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  enrollments Enrollment[]
  courses     Course[]
  attendance  Attendance[]

  @@map("semesters")
}

model Enrollment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  courseId   String   @db.ObjectId
  semesterId String?  @db.ObjectId
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id])
  course   Course    @relation(fields: [courseId], references: [id])
  semester Semester? @relation(fields: [semesterId], references: [id])

  @@map("enrollments")
}

model Attendance {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  userId     String           @db.ObjectId
  courseId   String           @db.ObjectId
  semesterId String?          @db.ObjectId
  date       DateTime
  status     AttendanceStatus
  createdAt  DateTime         @default(now())

  user     User      @relation(fields: [userId], references: [id])
  course   Course    @relation(fields: [courseId], references: [id])
  semester Semester? @relation(fields: [semesterId], references: [id])

  @@map("attendance")
}

model Assignment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  courseId    String   @db.ObjectId
  creatorId   String   @db.ObjectId
  dueDate     DateTime
  maxMarks    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User         @relation("AssignmentCreator", fields: [creatorId], references: [id])
  course      Course       @relation(fields: [courseId], references: [id])
  submissions Submission[]

  @@map("assignments")
}

model Submission {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String           @db.ObjectId
  studentId    String           @db.ObjectId
  content      String?
  filePath     String?
  marks        Int?
  feedback     String?
  status       SubmissionStatus @default(SUBMITTED)
  submittedAt  DateTime         @default(now())
  gradedAt     DateTime?

  assignment Assignment @relation(fields: [assignmentId], references: [id])
  student    User       @relation(fields: [studentId], references: [id])

  @@map("submissions")
}

model Notice {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  content    String
  priority   Priority @default(MEDIUM)
  authorId   String   @db.ObjectId
  targetRole Role?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id])

  @@map("notices")
}

model Message {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  content    String
  senderId   String   @db.ObjectId
  receiverId String   @db.ObjectId
  chatType   ChatType @default(PRIVATE)
  roomId     String?
  createdAt  DateTime @default(now())

  sender   User @relation("MessageSender", fields: [senderId], references: [id])
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id])

  @@map("messages")
}

model Timetable {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String   @db.ObjectId
  dayOfWeek Int
  startTime String
  endTime   String
  room      String
  createdAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id])

  @@map("timetable")
}

model Prediction {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  studentId        String    @db.ObjectId
  courseId         String?   @db.ObjectId
  predictedGrade   String
  riskLevel        RiskLevel
  attendanceRate   Float
  assignmentScore  Float
  confidence       Float
  recommendations  String[]
  createdAt        DateTime  @default(now())

  student User @relation(fields: [studentId], references: [id])

  @@map("predictions")
}

model FacultyCourse {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  facultyId String   @db.ObjectId
  courseId  String   @db.ObjectId
  createdAt DateTime @default(now())

  faculty User   @relation(fields: [facultyId], references: [id])
  course  Course @relation(fields: [courseId], references: [id])

  @@map("faculty_courses")
}

model LeaveApplication {
  id                  String      @id @default(auto()) @map("_id") @db.ObjectId
  studentId           String      @db.ObjectId
  startDate           DateTime
  endDate             DateTime
  reason              String
  leaveType           LeaveType
  status              LeaveStatus @default(PENDING)
  facultyStatus       String?
  adminStatus         String?
  facultyApprovedById String?     @db.ObjectId
  adminApprovedById   String?     @db.ObjectId
  facultyApprovedAt   DateTime?
  adminApprovedAt     DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  student           User  @relation("StudentLeaves", fields: [studentId], references: [id])
  approvedByFaculty User? @relation("FacultyApprovedLeaves", fields: [facultyApprovedById], references: [id])
  approvedByAdmin   User? @relation("AdminApprovedLeaves", fields: [adminApprovedById], references: [id])

  @@map("leave_applications")
}

enum Role {
  ADMIN
  FACULTY
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum SubmissionStatus {
  SUBMITTED
  GRADED
  LATE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ChatType {
  PRIVATE
  GROUP
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LeaveType {
  SICK
  PERSONAL
  EMERGENCY
  MEDICAL
  OTHER
}

enum LeaveStatus {
  PENDING
  FACULTY_APPROVED
  APPROVED
  REJECTED
}